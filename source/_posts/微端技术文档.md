## 微端多平台/渠道思路

### 思路1.单母包 多配置表

微端只打包一次但每个平台有自己的配置文件，微端启动时读取配置文件识别当前平台，并传平台参数给游戏。

- 微端母包一个
- 每个平台的配置文件单独一份
  - you49.json
  - ewan21.json
  - duowan.json

发不同渠道的微端

- A渠道配置文件+微端母包 
- B渠道配置文件+微端母包 
- C渠道配置文件+微端母包 


### 思路2.打多次包 宏定义

各渠道需要的配置信息写在代码中，通过宏定义区分不同的渠道，如下所示

```csharp
	     string loginURL = "";
#if you49
		loginURL = http://ylxxz.49you.com/client_login.html
#elif ewan21
		loginURL = http://www.2lewan.com/client/ylxxz
#elif duowan
		loginURL = http://www.duowan.com/ylxxz
#endif
```

## 我的解决方案

经过思考对比后决定使用思路1，注意点，安装器不同渠道要打不同包

自己编写简易多渠道打包工具，整合母包+配置文件，安装器打包

- 主界面

- 渠道选择界面

- 打包结果界面

### 安装器打包思路

1. 合并安装器+配置文件
2. vs打包配置(xml)
3. 配置信息写在代码中，替换代码配置文件或动态生成代码配置文件

### 1. 安装器和config合并

ilmerge：只能合并.net assemblies ，不能合并txt等非.net类型文件

http://www.microsoft.com/en-us/download/details.aspx?id=17630

https://ilmergegui.codeplex.com/

创建纯资源dll

https://msdn.microsoft.com/zh-cn/library/24b2tcy0%28VS.80%29.aspx?f=255&MSPPError=-2147217396

思考后觉得本末倒置了，所以决定使用msbuild来打包不同的安装器

### 2. msbuild

在 Visual Studio 中构建应用程序  https://msdn.microsoft.com/zh-cn/library/cyz1h6zd.aspx

msbuild: https://msdn.microsoft.com/zh-cn/library/dd393574.aspx

msbuild + xml (uninst.csproj)

```xml
 <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Test|AnyCPU'">
    <OutputPath>bin\Test\</OutputPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x64'">
    <PlatformTarget>x64</PlatformTarget>
    <OutputPath>bin\x64\Debug\</OutputPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x64'">
    <PlatformTarget>x64</PlatformTarget>
    <OutputPath>bin\x64\Release\</OutputPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Test|x64'">
    <PlatformTarget>x64</PlatformTarget>
    <OutputPath>bin\x64\Test\</OutputPath>
    <DefineConstants>you49</DefineConstants>
  </PropertyGroup>
```

## 页游多平台/多渠道

### 思路:渠道参数 对接渠道SDK

### 充值回调链接

以49you的充值回调为例

```html
http://{0}/default/weblogin/RequestPay.php?roleid={1}
```

拼接请求url：http://218.15.113.133/default/weblogin/RequestPay.php?roleid=212

服务器返回json

```json
{"ret":0,"url":"http:\/\/pay.49you.com\/?gid=161&scode=0&info=eyJyb2xlaWQiOjIxMn0="}
```

解析之后：http://pay.49you.com/?gid=161&scode=0&info=eyJyb2xlaWQiOjExMTB9

### 腾讯广点通

接入QQ用户的玩家登录，黄钻信息，VIP信息，充值信息

### 四九游

接入登录，充值信息



## TODO

快速完成法

ylwd中写url

launcher/fileupdate config.json

## 扩展资料

### LogicModule

微端有关的逻辑功能抽取在此模块，目前已处理的有

- Launcher
- AssistApp

待处理
- FileUpdate
- Ylwd_Setup


### json库

Newtonsoft.Json免费：http://www.newtonsoft.com/json/help/html/Introduction.htm

**可能遇到的错误**

错误代码：4  描述：缺少编译器要求的成员“System.Runtime.CompilerServices.ExtensionAttribute..ctor”	

这个问题相信大多数 .neter 都遇到过， 处理方法一般是删除“Newtonsoft.dll”， 再重新引用。

但这个动作做得多了， 还是很烦，可以在 JsonHelper (或其它引用到 Newtonsoft.dll 的类)中添加：

```csharp
//缺少编译器要求的成员“ystem.Runtime.CompilerServices.ExtensionAttribute..ctor”  
namespace System.Runtime.CompilerServices  
{  
    public class ExtensionAttribute : Attribute { }  
} 
```
### 参考资料

http://www.programgo.com/article/66182300875/